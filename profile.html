<!DOCTYPE html>
<html>
	<head>
		<title> {{ .user.ID }}'s Profile </title>
		<link rel="stylesheet" type="text/css" href="/static/profile.css">
	</head>
	<body>
		<div id="header">
			<h1 id="app-name"> Spotify Group Queue </h1>
			<a id="logout" href="/logout"> Logout </a>
		</div>

		<div class="content">
			<h2 id="user-id"> {{ .user.ID }}'s Queue </h2>
			<h4> Room Code: {{ .code }} </h4>

			{{ if not .isActive }}
				<button id="open-room"> Open the room </button>
			{{ end }}

			{{ if and .isActive .isOwner }}
				<button id="close-room"> Close the room </button>
			{{ end }}


			<form id="search-form">
				<input class="search-bar" placeholder="Song name">
				<input id="room-code" type="hidden" value="{{ .code }}">
			</form>

			<div id="song-container">
			</div>
		</div> <!-- .content -->

		<script
		  src="https://code.jquery.com/jquery-3.3.1.min.js"
		  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
		  crossorigin="anonymous">
		</script>

		<script>
			// Used in multiple functions and is constant
			var roomCode = $("#room-code").val()

			$("#search-form").submit(searchSubmit);

			function searchSubmit() {
				var songName = $(".search-bar").val()
				
				$.ajax({
					type: "POST",
					url: "/search",
					data: { "songName": songName, "roomCode": roomCode },
					success: updateSongList
				})

				// Don't refresh the page
				return false;
			}

			function updateSongList(resultData) {
				// Clear out any songs added earlier
				$("#song-container").empty()

				for(var i = 0; i < 10; i++) {
					var item = resultData[i]
					var elem = $("<div class='song-item'>" +
									"<img src=" + item.album.images[2].url + ">" +
									"<h3>" + item.name + "</h3>" +
									"<p>" + item.artists[0].name + "</p>" +
									"<button class='add' id=" + item.id + ">" + "Add to queue </button" +
								  "</div>"
								);

					$("#song-container").append(elem);
				}

			$(".add").click(addToQueue);

			}

			function addToQueue(e) {
				var songID = e.target.id

				$.ajax({
					type: "POST",
					url: "/add",
					data: { "songID": songID, "roomCode": roomCode },
					success: function() {
						console.log(e)
						e.target.innerHTML = "Added!"
						e.target.style.backgroundColor = '#1DB954';
					}
				})
			}

			$("#open-room").click(openRoom)
			
			function openRoom() {
				$.ajax({
					type: "POST",
					url: "/room/open",
					success: function() {
						location.reload();
					}
				})
			}

			$("#close-room").click(closeRoom)
			
			function closeRoom() {
				$.ajax({
					type: "POST",
					url: "/room/close",
					success: function() {
						location.reload();
					}
				})
			}
		</script>
	</body>
</html>
