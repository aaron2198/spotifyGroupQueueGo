<!DOCTYPE html>
<html>
	<head>
		<title> {{ .user.ID }}'s Profile </title>
		<link rel="stylesheet" type="text/css" href="/static/profile.css">
		<link rel="stylesheet" type="text/css" href="/static/styles.css">
	</head>
	<body>
		<div class="modal-bg"></div>
		<div class="header">
			<h1 id="app-name-profile"> Spotify Group Queue </h1>

			{{ if and (not .isActive) (not .playlistExists) (.isOwner) }}	
				<a id="create-playlist"> No playlist. <span>Create</span> one? </a>
			{{ end }}

			{{ if and (not .isActive) (.playlistExists) (.isOwner) }}
				<a id="open-room"> <span>Open</span> the Room? </a>
			{{ end }}

			{{ if and .isActive .isOwner }}
				<a id="close-room"> <span>Close</span> the Room? </a>
			{{ end }}
			
			{{ if .isLoggedIn }}
				<a id="logout" href="/logout"> Logout </a>
			{{ end }}
		</div>

		<div class="content">
			{{ if .isActive }}
				<h3> Room Code: {{ .code }} </h3>	
				<a id="open-search-modal" class="cta-btn"> Add to the Queue </a>
			{{ end }}
	
			<div id="queue-songs-container">
				{{ range .queueSongs }}
					<div class="queue-song">
						<img src="{{ (index .Track.Album.Images 1).URL }}">
						<div class="details">
							<h3> {{ .Track.Name }} </h3>
							<p> {{ (index .Track.Artists 0).Name }} </p>
						</div>
					</div>
				{{ end }}
			</div>

			<div id="search-modal" class="modal">
				<form id="search-form">
					<input class="search-bar" placeholder="Song name">
					<input id="room-code" type="hidden" value="{{ .code }}">
				</form>

				<div id="song-container">
				</div>
			</div>
		</div> <!-- .content -->

		<footer>
			<p> Made by Aaron Raff </p>
		</footer>

		<script
		  src="https://code.jquery.com/jquery-3.3.1.min.js"
		  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
		  crossorigin="anonymous">
		</script>

		<script>
			// Used in multiple functions and is constant
			var roomCode = $("#room-code").val();

			$("#search-form").submit(searchSubmit);

			function searchSubmit() {
				var songName = $(".search-bar").val()
				
				$.ajax({
					type: "POST",
					url: "/search",
					data: { "songName": songName, "roomCode": roomCode },
					success: updateSongList
				})

				// Don't refresh the page
				return false;
			}

			function updateSongList(resultData) {
				// Clear out any songs added earlier
				$("#song-container").empty()

				for(var i = 0; i < 10; i++) {
					var item = resultData[i]
					var elem = $("<div class='queue-song'>" +
									"<img src=" + item.album.images[2].url + ">" +
									"<div class='details'>" +
										"<h3>" + item.name + "</h3>" +
										"<p>" + item.artists[0].name + "</p>" +
									"</div>" +
									"<a class='cta-btn add' id=" + item.id + ">" + "Add </a>" +
								  "</div>"
								);

					$("#song-container").append(elem);
				}

			$(".add").click(addToQueue);

			}

			function addToQueue(e) {
				var songID = e.target.id

				$.ajax({
					type: "POST",
					url: "/add",
					data: { "songID": songID, "roomCode": roomCode },
					success: function() {
						console.log(e)
						e.target.innerHTML = "Added!"
						e.target.style.backgroundColor = '#1DB954';
					}
				});
			}

			$("#create-playlist").click(createPlaylist);

			function createPlaylist() {
				$.ajax({
					type: "POST",
					url: "/playlist/create",
					success: function() {
						location.reload();
					}
				});
			}

			$("#open-room").click(openRoom);
			
			function openRoom() {
				$.ajax({
					type: "POST",
					url: "/room/open",
					success: function() {
						location.reload();
					}
				});
			}

			$("#close-room").click(closeRoom);
			
			function closeRoom() {
				$.ajax({
					type: "POST",
					url: "/room/close",
					success: function() {
						location.reload();
					}
				});
			}

			$("#open-search-modal").click(openSearchModal);

			function openSearchModal() {
				$(".modal-bg").show(500);
				$("#search-modal").show(500);
			}

			// Catch click outside of the modal
			$(".modal-bg").click(closeSearchModal);

			function closeSearchModal() {	
				$(".modal-bg").hide(500);
				$("#search-modal").hide(500);
			}

		</script>
	</body>
</html>
